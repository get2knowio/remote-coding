---
# Volume setup must happen BEFORE creating the user
- name: Check if volume device exists
  ansible.builtin.stat:
    path: "{{ g2k_volume_device }}"
  register: volume_device_stat
  when: g2k_volume_device | length > 0

- name: Check if volume is already formatted
  ansible.builtin.command:
    cmd: "blkid {{ g2k_volume_device }}"
  register: volume_blkid
  changed_when: false
  failed_when: false
  when:
    - g2k_volume_device | length > 0
    - volume_device_stat.stat.exists | default(false)

- name: Format volume with ext4 filesystem
  ansible.builtin.filesystem:
    fstype: ext4
    dev: "{{ g2k_volume_device }}"
  when:
    - g2k_volume_device | length > 0
    - volume_device_stat.stat.exists | default(false)
    - volume_blkid.rc != 0

- name: Create temporary mount point for home directory
  ansible.builtin.file:
    path: "/home/{{ g2k_user }}"
    state: directory
    mode: '0755'
  when:
    - g2k_volume_device | length > 0
    - volume_device_stat.stat.exists | default(false)

- name: Mount volume as user home directory
  ansible.posix.mount:
    path: "/home/{{ g2k_user }}"
    src: "{{ g2k_volume_device }}"
    fstype: ext4
    opts: defaults,nofail
    state: mounted
  when:
    - g2k_volume_device | length > 0
    - volume_device_stat.stat.exists | default(false)

- name: Resize filesystem if volume was resized
  ansible.builtin.command:
    cmd: "resize2fs {{ g2k_volume_device }}"
  register: resize_result
  changed_when: "'Nothing to do' not in resize_result.stderr"
  when:
    - g2k_volume_device | length > 0
    - volume_device_stat.stat.exists | default(false)

- name: Create g2k user
  ansible.builtin.user:
    name: "{{ g2k_user }}"
    shell: /bin/bash
    create_home: true
    state: present

- name: Ensure home directory has correct ownership
  ansible.builtin.file:
    path: "/home/{{ g2k_user }}"
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'
    state: directory

- name: Create .ssh directory for g2k user
  ansible.builtin.file:
    path: "/home/{{ g2k_user }}/.ssh"
    state: directory
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0700'

- name: Check if authorized_keys already exists for g2k user
  ansible.builtin.stat:
    path: "/home/{{ g2k_user }}/.ssh/authorized_keys"
  register: g2k_authorized_keys

- name: Copy authorized_keys from root to g2k user
  ansible.builtin.copy:
    src: /root/.ssh/authorized_keys
    dest: "/home/{{ g2k_user }}/.ssh/authorized_keys"
    remote_src: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0600'
  when: not g2k_authorized_keys.stat.exists

- name: Add g2k user to docker group
  ansible.builtin.user:
    name: "{{ g2k_user }}"
    groups: docker
    append: true

- name: Configure passwordless sudo for g2k user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ g2k_user }}
    line: "{{ g2k_user }} ALL=(ALL) NOPASSWD:ALL"
    create: true
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Create devcontainer mount directories
  ansible.builtin.file:
    path: "/home/{{ g2k_user }}/{{ item }}"
    state: directory
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'
  loop:
    - .codex
    - .config/opencode
    - .config/gh
    - .coderabbit
    - .local/bin

- name: Create projects directory
  ansible.builtin.file:
    path: "{{ dev_workspace_dir }}"
    state: directory
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'

- name: Ensure ~/.local/bin is in PATH via .bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ g2k_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PATH"
    block: |
      # Add ~/.local/bin to PATH if it exists
      if [ -d "$HOME/.local/bin" ] ; then
          PATH="$HOME/.local/bin:$PATH"
      fi
    create: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0644'

- name: Configure terminal type fallback for unknown terminals
  ansible.builtin.blockinfile:
    path: "/home/{{ g2k_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - TERM FALLBACK"
    block: |
      # Fallback for unknown terminal types (e.g., xterm-ghostty)
      # This prevents "unknown terminal type" errors when using modern terminals
      if ! infocmp "$TERM" &>/dev/null 2>&1; then
          export TERM=xterm-256color
      fi
    create: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0644'
    insertbefore: "# {mark} ANSIBLE MANAGED BLOCK - PROJECT MENU"

- name: Configure project-menu auto-start on SSH login
  ansible.builtin.blockinfile:
    path: "/home/{{ g2k_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - PROJECT MENU"
    block: |
      # Auto-start project-menu on SSH login
      # Only trigger when:
      #   - Shell is interactive
      #   - Session is SSH (SSH_TTY or SSH_CONNECTION is set)
      #   - Not already inside a zellij session
      #   - Not already inside a devcontainer
      if [[ $- == *i* ]] && [[ -n "$SSH_TTY" || -n "$SSH_CONNECTION" ]] && [[ -z "$ZELLIJ" ]] && [[ -z "$REMOTE_CONTAINERS" ]]; then
          project-menu
          exit
      fi
    create: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0644'
    insertafter: EOF

- name: Configure devcontainer auto-start inside zellij sessions
  ansible.builtin.blockinfile:
    path: "/home/{{ g2k_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - DEVCONTAINER AUTO-START"
    block: |
      # Auto-start devcontainer when inside a zellij session for a devcontainer project
      # Only trigger when:
      #   - Shell is interactive
      #   - Inside zellij (ZELLIJ_SESSION_NAME is set)
      #   - Not already inside a devcontainer
      if [[ $- == *i* ]] && [[ -n "$ZELLIJ_SESSION_NAME" ]] && [[ -z "$REMOTE_CONTAINERS" ]]; then
          _project_dir="{{ dev_workspace_dir }}/$ZELLIJ_SESSION_NAME"
          if [[ -d "$_project_dir/.devcontainer" ]] || [[ -f "$_project_dir/.devcontainer.json" ]]; then
              cd "$_project_dir"
              echo "Starting devcontainer for $ZELLIJ_SESSION_NAME..."
              devcontainer up --workspace-folder "$_project_dir"
              echo ""
              echo "Entering devcontainer (exit to return to host shell)..."
              echo ""
              exec devcontainer exec --workspace-folder "$_project_dir" /bin/bash -c \
                  'if command -v zsh &> /dev/null; then exec zsh; else exec bash; fi'
          fi
          unset _project_dir
      fi
    create: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0644'
    insertafter: EOF

- name: Ensure .bash_profile sources .bashrc for login shells
  ansible.builtin.blockinfile:
    path: "/home/{{ g2k_user }}/.bash_profile"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - BASHRC"
    block: |
      # Debug logging for SSH login
      echo "[DEBUG] .bash_profile starting" >> /tmp/shell-debug.log
      echo "[DEBUG] TERM=$TERM" >> /tmp/shell-debug.log
      
      # Fallback for unknown terminal types (e.g., xterm-ghostty)
      # This MUST happen before sourcing .bashrc or any interactive commands
      if ! infocmp "$TERM" &>/dev/null 2>&1; then
          echo "[DEBUG] TERM '$TERM' not recognized, falling back to xterm-256color" >> /tmp/shell-debug.log
          export TERM=xterm-256color
      fi
      echo "[DEBUG] TERM after fix=$TERM" >> /tmp/shell-debug.log
      
      # Source .bashrc for interactive login shells (like SSH)
      if [ -f "$HOME/.bashrc" ]; then
          echo "[DEBUG] Sourcing .bashrc" >> /tmp/shell-debug.log
          source "$HOME/.bashrc"
      fi
      echo "[DEBUG] .bash_profile done" >> /tmp/shell-debug.log
    create: true
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0644'

- name: Install devshell helper script
  ansible.builtin.template:
    src: devshell.sh.j2
    dest: "/home/{{ g2k_user }}/.local/bin/devshell"
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'

- name: Install project-menu script
  ansible.builtin.template:
    src: project-menu.sh.j2
    dest: "/home/{{ g2k_user }}/.local/bin/project-menu"
    owner: "{{ g2k_user }}"
    group: "{{ g2k_user }}"
    mode: '0755'

- name: Verify g2k user exists
  ansible.builtin.command: id {{ g2k_user }}
  register: user_setup_user_info
  changed_when: false

- name: Display user information
  ansible.builtin.debug:
    msg: "User created: {{ user_setup_user_info.stdout }}"
